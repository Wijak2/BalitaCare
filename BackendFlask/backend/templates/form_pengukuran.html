<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Pengukuran IoT</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light p-5">

  <div class="container">
    <div class="card shadow p-4 mx-auto" style="max-width: 550px;">
      <h4 class="mb-3 text-center">ğŸ§’ Mulai Pengukuran</h4>

      <!-- ALERT NOTIFIKASI -->
      {% if success %}
      <div class="alert alert-success text-center">
        âœ… Data berhasil disimpan ke database!
      </div>
      {% elif error %}
      <div class="alert alert-danger text-center">
        âš ï¸ {{ error }}
      </div>
      {% endif %}

      <form method="POST" action="{{ url_for('iot.save_current') }}">
        <!-- Pilih Anak -->
        <div class="mb-3">
          <label for="id_anak" class="form-label">Pilih Anak</label>
          <select class="form-select" id="id_anak" name="id_anak" required>
            <option value="" disabled selected>-- pilih anak --</option>
            {% for anak in anak_list %}
              <option value="{{ anak.id_anak }}">{{ anak.nama_anak }} (ID: {{ anak.id_anak }})</option>
            {% endfor %}
          </select>
        </div>

        <!-- Jenis Pengukuran -->
        <div class="mb-3">
          <label for="jenis" class="form-label">Jenis Pengukuran</label>
          <select class="form-select" id="jenis" name="jenis" required>
            <option value="" disabled selected>-- pilih jenis --</option>
            <option value="kepala">Lingkar Kepala</option>
            <option value="lengan">Lingkar Lengan</option>
          </select>
        </div>

        <!-- Pilih ID Pengukuran -->
        <div class="mb-3">
          <label for="id_pengukuran" class="form-label">Pilih ID Pengukuran</label>
          <div class="input-group">
            <select class="form-select" id="id_pengukuran" name="id_pengukuran">
              <option value="" selected>-- Buat Baru --</option>
              {% for peng in pengukuran_list %}
                <option value="{{ peng.id_pengukuran }}">
                  ID {{ peng.id_pengukuran }} - Anak {{ peng.id_anak }}
                </option>
              {% endfor %}
            </select>
            <button type="button" id="buatBaruBtn" class="btn btn-outline-primary">â• Buat Baru</button>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Hasil Pengukuran IoT</label>
          <pre id="latest-data" class="bg-light p-2 border rounded text-center">Menunggu data IoT...</pre>
        </div>
        <!-- Input Manual -->
        <div class="mb-3">
          <label for="tinggi_badan" class="form-label">Tinggi Badan (cm)</label>
          <input type="number" class="form-control" id="tinggi_badan" name="tinggi_badan" step="0.1" placeholder="Masukkan tinggi badan">
        </div>

        <div class="mb-3">
          <label for="berat_badan" class="form-label">Berat Badan (kg)</label>
          <input type="number" class="form-control" id="berat_badan" name="berat_badan" step="0.1" placeholder="Masukkan berat badan">
        </div>

        <!-- Hasil Pengukuran dari IoT -->

        <!-- Tombol Simpan -->
        <button type="submit" class="btn btn-success w-100">ğŸ’¾ Simpan ke Database</button>
      </form>
    </div>
  </div>

  <script>
    async function fetchData() {
      try {
        const res = await fetch("/iot/latest-json");
        const data = await res.json();
        document.getElementById("latest-data").innerText =
          Object.keys(data).length === 0
            ? "Belum ada data POST dari IoT"
            : JSON.stringify(data, null, 2);
      } catch {
        document.getElementById("latest-data").innerText = "âš ï¸ Gagal ambil data IoT";
      }
    }

    setInterval(fetchData, 2000);
    fetchData();

    document.getElementById("buatBaruBtn").addEventListener("click", () => {
      document.getElementById("id_pengukuran").value = "";
    });
  </script>

</body>
</html>
